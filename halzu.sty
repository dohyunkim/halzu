\ProvidesPackage{halzu}[2015/07/16 v0.5 Halzu, 할주, 割註, Warichu, split annotation]
\RequirePackage{zref-savepos}
\newcount\halzucnt \halzucnt\z@
\protected\def\halzu#1{%
  \begingroup\leavevmode \let\fontsubfuzz\maxdimen
  \dimen6 \halzusize\dimexpr\f@size pt\relax
  \setbox6\hbox{\fontsize{2.1\dimen6}\z@\selectfont\char40}%
  \penalty\z@\lower\dimexpr\halzulower\relax\copy6\nobreak\hskip\z@
  \global\advance\halzucnt\@ne
  \zsaveposx{halz@h@\the\halzucnt}%
  \vadjust{\hfill\zsaveposx{halz@e@\the\halzucnt}\kern\rightmargin}%
  \dimen@\dimexpr\zposx{halz@e@\the\halzucnt}sp-\zposx{halz@h@\the\halzucnt}sp\relax
  \dimen@ii\dimexpr\linewidth-\leftskip-\rightskip\relax
  \ifdim\dimen@=\z@ \dimen@\dimen@ii \fi
  \vbadness\maxdimen \vfuzz\maxdimen \splittopskip\z@
  \linespread\@ne \parindent\z@ \leftskip\z@ \rightskip\z@
  \fontsize{\dimen6}{1.1\dimen6}\selectfont
  \setbox\z@\hbox{#1}%
  \ifdim\dimen@<\dimexpr 0.5\wd\z@+\wd6\relax
    \halz@first@two{#1}\dimen@
  \fi
  \halz@remaining
  \unpenalty\lower\dimexpr\halzulower\relax\hbox{\fontsize{2.1\dimen6}\z@\selectfont\char41}%
  \endgroup
}
\def\halz@first@two#1#2{% #1: contents; #2: width of first two lines
  \setbox\z@\vbox{\hsize #2\emergencystretch.2em \parshape\thr@@\z@#2\z@#2\z@\maxdimen #1}%
  \setbox\tw@\vsplit\z@ to\tw@\baselineskip
  \halz@typeset{\unvbox\tw@}{\wd\tw@}\penalty\z@
  \setbox\z@\hbox{%
    \loop
      \setbox\tw@\vsplit\z@ to\baselineskip
      \unless\ifvoid\tw@
        \setbox\tw@\vbox{\unvbox\tw@\global\setbox\@ne\lastbox}%
        \unhbox\@ne\unskip
    \repeat
  }%
}
\def\halz@remaining{%
  \dimen@ 0.5\wd\z@ % check the maximum width of each line.
  \dimen4 \wd\z@    % check the minimum width of each line.
  \count@ \z@       % check the number of lines
  \setbox\tw@\vbox{\hbadness\maxdimen\hfuzz\maxdimen\hsize\dimen@\unhcopy\z@}%
  \loop
    \setbox4\vsplit\tw@ to\baselineskip
    \unless\ifvoid4
      \advance\count@\@ne
      \setbox4\vbox{\unvbox4\global\setbox\@ne\lastbox}%
      \setbox4\hbox{\unhbox\@ne}%
      \ifdim\wd4>\dimen@ \dimen@\wd4 \fi
      \ifdim\wd4<\dimen4 \dimen4\wd4 \fi
  \repeat
  \ifdim\dimen@>\z@
    \ifnum\count@>\tw@ \advance\dimen@\dimen4 \fi
    \ifdim\dimen@ii<\dimen@
      \halz@first@two{\unhbox\z@}\dimen@ii
      \halz@remaining % self-reference
    \else
      \halz@typeset{\unhbox\z@
        \ifnum\count@<\tw@ \ifdim\ht\z@<\baselineskip \break \fi\fi
      }\dimen@
    \fi
  \fi
}
\def\halz@typeset#1#2{% 1: contents; 2: width,
  \setbox4\hbox{$\vcenter{\hsize#2#1}$}%
  \raise.5\dimexpr \ht6 -\ht4 +\dp4 -\dp6 -\tw@\dimexpr\halzulower\relax\relax\box4
}
\let\halzulower\z@
\def\halzusize{0.7}
